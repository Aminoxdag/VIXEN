<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VIXEN V2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: "Open Sans", sans-serif;
            background-color: #000;
            -webkit-font-smoothing: none;
            -moz-osx-font-smoothing: grayscale;
            font-smooth: never;
        }
        p, span, button, div, input {
            line-height: 1.5;
        }
        #app-container.fullscreen-mode {
            position: fixed; 
            inset: 0; 
            width: 100vw; /* Use viewport width */
            height: 100vh; /* Use viewport height */
            border-radius: 0; /* Ensure no rounded corners in fullscreen */
        }
        #player-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            max-width: 90vw;
            max-height: 75vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #app-container.normal-mode {
            width: 100%; 
            height: 100%;
            position: relative;
            z-index: 2;
        }
        .loader {
            border: 5px solid rgba(255, 255, 255, 0.2);
            border-top-color: #fff; border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        #main-player-video::-webkit-media-controls { display: none !important; }
        #main-player-video { -webkit-mask-image: -webkit-radial-gradient(white, black); }

        .btn-glass {
            background-color: rgba(30, 30, 30, 0.25);
            backdrop-filter: blur(12px) saturate(150%);
            -webkit-backdrop-filter: blur(12px) saturate(150%);
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.2s ease-in-out;
        }
        .btn-glass:hover {
            background-color: rgba(30, 30, 30, 0.4);
            border-color: rgba(255, 255, 255, 0.25);
        }
        .text-blend-overlay {
            color: white;
            mix-blend-mode: overlay;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            transform: translateZ(0); 
        }
        .quality-filter-btn.active {
            background-color: #000;
            color: #ffff;
            font-weight: bold;
        }

        #ambient-canvas {
            position: absolute;
            top: 60%; 
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            height: 40%; 
            z-index: 1; 
            filter: blur(80px);
            opacity: 0;
            transition: opacity 0.7s ease-in-out;
        }
        #ambient-canvas.active {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-black text-white overflow-hidden">

    <!-- Password Protection Overlay -->
    <div id="password-overlay" class="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-[100] p-4">
        <div class="btn-glass rounded-lg shadow-2xl p-8 w-full max-w-sm text-white text-center">
            <h2 class="text-2xl font-bold mb-4 text-blend-overlay">Enter Password</h2>
            <p class="text-xs text-white/50 mb-6 text-blend-overlay">You need a password to access this page.</p>
            <input id="password-input" type="password" class="btn-glass w-full p-3 text-center text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-white/50 focus:border-transparent placeholder:text-white/40" placeholder="••••••••">
            <p id="password-error" class="text-red-400 text-xs mt-2 hidden">Incorrect password. Please try again.</p>
            <button id="submit-password-btn" class="btn-glass mt-6 w-full py-3 rounded-lg text-white font-bold">
                Unlock
            </button>
        </div>
    </div>


    <div id="view-wrapper" class="w-full h-screen flex items-center justify-center">
        <div id="layout-container" class="flex flex-col items-center justify-center gap-6">
            
            <div id="top-nav-controls" class="hidden w-full max-w-lg">
                <div class="flex items-center justify-between px-2">
                    <div id="top-prev-btn" class="cursor-pointer text-white/70 hover:text-white transition-colors p-2"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
                    <div id="mini-view-buttons" class="flex items-center gap-2"></div>
                    <div id="top-next-btn" class="cursor-pointer text-white/70 hover:text-white transition-colors p-2"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                </div>
            </div>

            <div id="player-wrapper">
                <canvas id="ambient-canvas"></canvas>
                <!-- The 'rounded-lg' class is now managed by JavaScript -->
                <div id="app-container" class="relative overflow-hidden">
                    <video id="main-player-video" class="w-full h-full transition-all duration-300" preload="auto" playsinline></video>
                    
                    <!-- Aggressive Preload Players -->
                    <video class="preload-player hidden" preload="auto" playsinline muted></video>
                    <video class="preload-player hidden" preload="auto" playsinline muted></video>
                    <video class="preload-player hidden" preload="auto" playsinline muted></video>
                    
                    <div class="absolute inset-0 z-20">
                        <div id="loader" class="absolute inset-0 flex flex-col items-center justify-center bg-black/50"><div class="loader"></div><p class="mt-4 text-xs text-blend-overlay">Loading...</p></div>
                        <div id="error-message" class="hidden absolute inset-0 bg-black/70 flex-col items-center justify-center text-center p-4"><p class="text-xs text-blend-overlay">Error loading video.</p><p class="text-xs text-gray-400 mt-2 text-blend-overlay">Trying another video.</p></div>
                        <div id="play-overlay" class="hidden absolute inset-0 bg-black/30 flex-col items-center justify-center cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="mix-blend-mode: overlay;"><circle cx="12" cy="12" r="10"></circle><polygon points="10 8 16 12 10 16 10 8"></polygon></svg><p class="mt-2 text-sm text-blend-overlay">Click to Play</p></div>
                        
                        <div id="quality-menu-container" class="absolute top-4 left-4">
                            <div id="quality-menu-btn" class="btn-glass px-3 py-2 rounded-md hidden text-xs font-bold text-blend-overlay cursor-pointer"></div>
                            <div id="quality-popover" class="hidden absolute top-full mt-2 w-40 btn-glass rounded-lg shadow-2xl p-2">
                                <div class="flex flex-col gap-1">
                                    <button data-filter="All" class="quality-filter-btn text-left w-full px-3 py-2 rounded-md hover:bg-white/10 text-xs text-blend-overlay">All</button>
                                    <button data-filter="Pomf" class="quality-filter-btn text-left w-full px-3 py-2 rounded-md hover:bg-white/10 text-xs text-blend-overlay">Pomf</button>
                                    <button data-filter="Twitter" class="quality-filter-btn text-left w-full px-3 py-2 rounded-md hover:bg-white/10 text-xs text-blend-overlay">Twitter</button>
                                    <button data-filter="TwitterFHD" class="quality-filter-btn text-left w-full px-3 py-2 rounded-md hover:bg-white/10 text-xs text-blend-overlay">Twitter FHD</button>
                                </div>
                                <hr class="border-white/10 my-2">
                                <button id="info-btn" class="text-left w-full px-3 py-2 rounded-md hover:bg-white/10 text-xs text-blend-overlay flex items-center justify-center gap-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>
                                    <span>Info</span>
                                </button>
                            </div>
                        </div>

                        <div id="top-right-button-container" class="absolute top-4 right-4 flex items-center gap-2">
                            <div id="hide-ui-btn" class="btn-glass cursor-pointer p-2 rounded-full text-white/70 hover:text-white">
                               <svg id="icon-eye-visible" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                               <svg id="icon-eye-hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"></path><line x1="1" y1="1" x2="23" y2="23"></line></svg>
                            </div>
                            <div id="loop-btn" class="btn-glass cursor-pointer p-2 rounded-full text-white/70 hover:text-white">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="17 1 21 5 17 9"></polyline><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><polyline points="7 23 3 19 7 15"></polyline><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                            </div>
                            <div id="mute-btn" class="btn-glass cursor-pointer p-2 rounded-full">
                                <svg id="icon-unmuted" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                                <svg id="icon-muted" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
                            </div>
                        </div>

                        <div id="fullscreen-nav-controls" class="w-full flex items-center justify-between absolute top-1/2 -translate-y-1/2 px-4">
                            <div id="fs-prev-btn" class="cursor-pointer text-white/70 hover:text-white transition-colors p-2"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg></div>
                            <div id="fs-next-btn" class="cursor-pointer text-white/70 hover:text-white transition-colors p-2"><svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg></div>
                        </div>
                    </div>
                    <div id="progress-bar-container" class="absolute bottom-0 left-0 w-full h-1 bg-white/20 z-30"><div id="progress-bar" class="h-full bg-white" style="width: 0%; transition: width 100ms linear;"></div></div>
                </div>
            </div>

            <div id="bottom-controls" class="flex flex-col sm:flex-row items-center gap-4 z-20 w-11/12 max-w-md mt-2">
                <button id="play-full-btn" class="btn-glass w-full sm:w-auto justify-center text-white py-3 px-6 rounded-lg transform hover:scale-105 shadow-lg flex items-center gap-3 text-xs"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg><span class="text-blend-overlay">Watch Full</span></button>
                <button id="toggle-view-btn" class="btn-glass w-full sm:w-auto justify-center text-white py-3 px-6 rounded-lg transform hover:scale-105 shadow-lg flex items-center gap-3 text-xs"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg><span id="toggle-view-text" class="text-blend-overlay">Mini View</span></button>
            </div>
        </div>
    </div>

    <!-- Full screen video modal -->
    <div id="video-modal" class="hidden fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-black/50 border border-white/10 rounded-lg shadow-2xl w-full max-w-4xl max-h-full flex flex-col relative overflow-hidden">
            <div class="flex justify-end items-center p-2 w-full absolute top-0 right-0 z-10">
                <div class="flex items-center gap-2">
                    <button id="copy-link-btn" title="Copy Link" class="btn-glass text-white rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="copy-icon"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="check-icon hidden"><polyline points="20 6 9 17 4 12"></polyline></svg>
                    </button>
                    <button id="close-modal-btn" title="Close" class="btn-glass text-white rounded-full p-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            </div>
            <div class="w-full h-full flex-1">
                 <video id="modal-player" class="w-full h-full" autoplay controls></video>
            </div>
        </div>
    </div>

    <!-- Statistics Modal -->
    <div id="stats-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="btn-glass rounded-lg shadow-2xl p-6 w-full max-w-sm text-white">
            <h2 class="text-xl font-bold mb-4 text-center text-blend-overlay">Video Statistics</h2>
            <div class="space-y-3 text-sm font-mono">
                <p class="flex justify-between text-blend-overlay"><span>Total Videos:</span> <span id="stats-total" class="font-bold">0</span></p>
                <p class="flex justify-between text-blend-overlay"><span>Pomf Videos:</span> <span id="stats-pomf" class="font-bold">0</span></p>
                <p class="flex justify-between text-blend-overlay"><span>Twitter Videos:</span> <span id="stats-twitter" class="font-bold">0</span></p>
                <p class="flex justify-between text-blend-overlay"><span>Twitter FHD Videos:</span> <span id="stats-twitter-fhd" class="font-bold">0</span></p>
            </div>
            <button id="close-stats-modal-btn" class="mt-6 w-full btn-glass py-2 rounded-lg text-blend-overlay">Close</button>
        </div>
    </div>


    <script>
        // --- DOM ELEMENT SELECTION ---
        const passwordOverlay = document.getElementById('password-overlay');
        const passwordInput = document.getElementById('password-input');
        const submitPasswordBtn = document.getElementById('submit-password-btn');
        const passwordError = document.getElementById('password-error');

        const mainPlayer = document.getElementById('main-player-video');
        const appContainer = document.getElementById('app-container');
        const playerWrapper = document.getElementById('player-wrapper');
        const layoutContainer = document.getElementById('layout-container');
        const preloadPlayers = document.querySelectorAll('.preload-player');
        const playFullBtn = document.getElementById('play-full-btn');
        const toggleViewBtn = document.getElementById('toggle-view-btn');
        const toggleViewText = document.getElementById('toggle-view-text');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        const playOverlay = document.getElementById('play-overlay');
        const progressBar = document.getElementById('progress-bar');
        const videoModal = document.getElementById('video-modal');
        const modalPlayer = document.getElementById('modal-player');
        const closeModalBtn = document.getElementById('close-modal-btn');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const bottomControls = document.getElementById('bottom-controls');
        const fullscreenNavControls = document.getElementById('fullscreen-nav-controls');
        const topNavControls = document.getElementById('top-nav-controls');
        const fsPrevBtn = document.getElementById('fs-prev-btn');
        const fsNextBtn = document.getElementById('fs-next-btn');
        const topPrevBtn = document.getElementById('top-prev-btn');
        const topNextBtn = document.getElementById('top-next-btn');
        const muteBtn = document.getElementById('mute-btn');
        const iconUnmuted = document.getElementById('icon-unmuted');
        const iconMuted = document.getElementById('icon-muted');
        const loopBtn = document.getElementById('loop-btn');
        const hideUiBtn = document.getElementById('hide-ui-btn');
        const iconEyeVisible = document.getElementById('icon-eye-visible');
        const iconEyeHidden = document.getElementById('icon-eye-hidden');
        const qualityMenuBtn = document.getElementById('quality-menu-btn');
        const qualityPopover = document.getElementById('quality-popover');
        const qualityFilterBtns = document.querySelectorAll('.quality-filter-btn');
        const infoBtn = document.getElementById('info-btn');
        const topRightButtonContainer = document.getElementById('top-right-button-container');
        const miniViewButtons = document.getElementById('mini-view-buttons');
        const statsModal = document.getElementById('stats-modal');
        const closeStatsModalBtn = document.getElementById('close-stats-modal-btn');
        const statsTotal = document.getElementById('stats-total');
        const statsPomf = document.getElementById('stats-pomf');
        const statsTwitter = document.getElementById('stats-twitter');
        const statsTwitterFhd = document.getElementById('stats-twitter-fhd');
        const ambientCanvas = document.getElementById('ambient-canvas');
        const ambientCtx = ambientCanvas.getContext('2d');

        // --- STATE VARIABLES ---
        let originalVideoList = [], videoList = [], history = [], currentIndex = -1, currentTrailerStartTime = 0;
        let isFullScreen = true, isLooping = false, isUiHidden = false, currentFilter = 'All';
        let trailerTimer, progressTimer, ambientAnimationId = null;
        let preloadingUrls = new Set();
        const VIDEO_LIST_URL = 'https://raw.githubusercontent.com/Aminoxdag/My-links/refs/heads/main/merged_list.txt';
        const TRAILER_DURATION_MS = 30000;
        const CORRECT_PASSWORD = '1432145';

        // --- AMBIENT MODE LOGIC ---
        function drawAmbientFrame() {
            if (isFullScreen || mainPlayer.paused || !ambientCtx) {
                if (ambientAnimationId) {
                    cancelAnimationFrame(ambientAnimationId);
                    ambientAnimationId = null;
                }
                return;
            }
            ambientCtx.drawImage(mainPlayer, 0, 0, ambientCanvas.width, ambientCanvas.height);
            ambientAnimationId = requestAnimationFrame(drawAmbientFrame);
        }

        // --- CORE FUNCTIONS ---
        function clearTimers() { clearTimeout(trailerTimer); clearInterval(progressTimer); }
        
        function updateNavButtons() {
            const showPrev = history.length > 1;
            fsPrevBtn.style.visibility = showPrev ? 'visible' : 'hidden';
            topPrevBtn.style.visibility = showPrev ? 'visible' : 'hidden';
        }

        function updateMuteIcon() {
            iconMuted.classList.toggle('hidden', !mainPlayer.muted);
            iconUnmuted.classList.toggle('hidden', mainPlayer.muted);
        }

        // --- UI MODE MANAGEMENT ---
        function setViewMode(fullscreen) {
            isFullScreen = fullscreen;
            mainPlayer.classList.toggle('object-cover', isFullScreen);
            mainPlayer.classList.toggle('object-contain', !isFullScreen);

            if (isFullScreen) {
                // Set styles for true fullscreen
                appContainer.style.aspectRatio = 'auto';
                appContainer.classList.remove('normal-mode', 'rounded-lg');
                appContainer.classList.add('fullscreen-mode');
                
                playerWrapper.style.display = 'none';
                layoutContainer.prepend(appContainer);
                
                ambientCanvas.classList.remove('active');
                if (ambientAnimationId) cancelAnimationFrame(ambientAnimationId);
                
                fullscreenNavControls.classList.remove('hidden');
                topNavControls.classList.add('hidden');
                toggleViewText.textContent = 'Mini View';
                appContainer.appendChild(bottomControls);
                bottomControls.classList.add('absolute', 'bottom-8', 'left-1/2', '-translate-x-1/2');
                topRightButtonContainer.append(hideUiBtn, loopBtn, muteBtn);
            } else {
                // Set styles for mini-view (not fullscreen)
                if (mainPlayer.videoWidth > 0) {
                     playerWrapper.style.aspectRatio = mainPlayer.videoWidth / mainPlayer.videoHeight;
                } else {
                     playerWrapper.style.aspectRatio = '16 / 9';
                }
                appContainer.style.aspectRatio = ''; // Let wrapper control aspect ratio
                appContainer.classList.remove('fullscreen-mode');
                appContainer.classList.add('normal-mode', 'rounded-lg'); // Add back rounded corners
                
                playerWrapper.style.display = 'flex';
                playerWrapper.prepend(appContainer);

                ambientCanvas.classList.add('active');
                drawAmbientFrame();

                fullscreenNavControls.classList.add('hidden');
                topNavControls.classList.remove('hidden');
                toggleViewText.textContent = 'Fullscreen';
                layoutContainer.appendChild(bottomControls);
                bottomControls.classList.remove('absolute', 'bottom-8', 'left-1/2', '-translate-x-1/2');
                miniViewButtons.append(hideUiBtn, loopBtn, muteBtn);
            }
        }

        // --- VIDEO & FILTERING LOGIC ---
        async function fetchVideoList() {
            try {
                const response = await fetch(VIDEO_LIST_URL, { cache: "no-store" });
                const text = await response.text();
                originalVideoList = text.split('\n').filter(url => url.trim().startsWith('http')).map(url => url.trim());
                if (originalVideoList.length === 0) throw new Error('Video list is empty.');
            } catch (error) { loader.innerHTML = '<p class="text-red-400 text-center p-4">Failed to load video list.</p>'; }
        }

        function applyFilter(filter) {
            currentFilter = filter;
            switch (filter) {
                case 'Pomf': videoList = originalVideoList.filter(url => url.includes('pomf2.lain.la')); break;
                case 'Twitter': videoList = originalVideoList.filter(url => url.includes('video.twimg.com/amplify_video')); break;
                case 'TwitterFHD': videoList = originalVideoList.filter(url => url.includes('video.twimg.com/amplify_video') && url.includes('1080')); break;
                default: videoList = [...originalVideoList]; break;
            }
            qualityFilterBtns.forEach(btn => btn.classList.toggle('active', btn.dataset.filter === currentFilter));
            history = [];
            updateNavButtons();
            preloadingUrls.clear();
            preloadPlayers.forEach(p => p.src = '');
        }

        function applyFilterAndPlay(filter) {
            applyFilter(filter);
            qualityPopover.classList.add('hidden');
            if (videoList.length > 0) {
                playTrailer(getNewRandomIndex());
            } else {
                loader.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorMessage.querySelector('p').textContent = `No videos found for "${filter}" filter.`;
                errorMessage.querySelector('p:last-child').textContent = 'Please select another filter.';
                clearTimers();
            }
        }

        function getNewRandomIndex(excludeUrls = []) {
            if (videoList.length <= 1) return 0;
            let newIndex, newUrl;
            const combinedExcludes = new Set([...excludeUrls, mainPlayer.src]);

            do {
                newIndex = Math.floor(Math.random() * videoList.length);
                newUrl = videoList[newIndex];
            } while (combinedExcludes.has(newUrl) && combinedExcludes.size < videoList.length);
            
            return newIndex;
        }

        // --- AGGRESSIVE & IMPROVED TIMING PRELOADING ---
        function managePreloading() {
            if (videoList.length < 2) return;

            preloadingUrls.clear();
            preloadingUrls.add(mainPlayer.src);
            preloadPlayers.forEach(p => {
                if (p.src) preloadingUrls.add(p.src);
            });

            preloadPlayers.forEach(player => {
                if (!player.src || player.readyState === 4) {
                    const newIndex = getNewRandomIndex(Array.from(preloadingUrls));
                    const newUrl = videoList[newIndex];
                    if (newUrl) {
                        player.src = newUrl;
                        player.load();
                        preloadingUrls.add(newUrl);
                    }
                }
            });
        }
        
        function getReadyPreloadedVideo() {
            for (const player of preloadPlayers) {
                if (player.src && player.readyState >= 3) {
                    const readyUrl = player.src;
                    player.src = '';
                    return readyUrl;
                }
            }
            return null;
        }

        function replayTrailer() {
            mainPlayer.currentTime = currentTrailerStartTime;
            mainPlayer.play().then(startTrailerPlayback).catch(err => console.error("Replay failed", err));
        }
        
        function startTrailerPlayback() {
            playOverlay.classList.add('hidden');
            clearTimers();
            drawAmbientFrame();
            const trailerStartTime = Date.now();
            progressTimer = setInterval(() => {
                const elapsed = Date.now() - trailerStartTime;
                progressBar.style.width = `${Math.min((elapsed / TRAILER_DURATION_MS) * 100, 100)}%`;
            }, 100);
            trailerTimer = setTimeout(() => {
                clearInterval(progressTimer);
                if (isLooping) replayTrailer(); else showNextVideo();
            }, TRAILER_DURATION_MS);
        }

        function playTrailer(indexOrUrl, isFromHistory = false) {
            let url, index;

            if (typeof indexOrUrl === 'string') {
                url = indexOrUrl;
                index = videoList.indexOf(url);
                if (index === -1) {
                    index = getNewRandomIndex();
                    url = videoList[index];
                }
            } else {
                index = indexOrUrl;
                url = videoList[index];
            }

            if (index === undefined || index < 0 || index >= videoList.length) { return; }

            clearTimers();
            progressBar.style.width = '0%';
            errorMessage.classList.add('hidden');
            playOverlay.classList.add('hidden');
            loader.classList.remove('hidden');
            mainPlayer.style.opacity = '0';
            qualityMenuBtn.classList.add('hidden');
            
            currentIndex = index;
            if (!isFromHistory) { history.push(currentIndex); }
            updateNavButtons();
            
            const onSeeked = () => {
                mainPlayer.removeEventListener('seeked', onSeeked);
                loader.classList.add('hidden');
                mainPlayer.style.opacity = '1';
                mainPlayer.play().then(startTrailerPlayback).catch(error => {
                    setTimeout(() => { if (mainPlayer.paused) playOverlay.classList.remove('hidden'); else startTrailerPlayback(); }, 150);
                });
            };

            const onLoadedMetadata = () => {
                mainPlayer.removeEventListener('loadedmetadata', onLoadedMetadata);
                ambientCanvas.width = mainPlayer.videoWidth / 10;
                ambientCanvas.height = mainPlayer.videoHeight / 10;
                setViewMode(isFullScreen); // This will correctly apply fullscreen/mini-view styles
                const videoSrc = mainPlayer.src;
                const videoHeight = mainPlayer.videoHeight;
                let qualityText = '';
                if (videoSrc.includes('pomf')) qualityText = 'Pomf';
                else if (videoSrc.includes('1080')) qualityText = '1080p';
                else if (videoHeight >= 720) qualityText = '720p';
                else if (videoHeight >= 480) qualityText = '480p';
                else if (videoHeight > 0) qualityText = `${videoHeight}p`;
                if (qualityText) {
                    qualityMenuBtn.textContent = qualityText;
                    qualityMenuBtn.classList.remove('hidden');
                }
                currentTrailerStartTime = Math.random() * mainPlayer.duration;
                mainPlayer.currentTime = currentTrailerStartTime;
                mainPlayer.addEventListener('seeked', onSeeked);
            };
            
            mainPlayer.onloadeddata = null;
            mainPlayer.addEventListener('loadedmetadata', onLoadedMetadata);
            mainPlayer.onerror = () => { 
                loader.classList.add('hidden'); 
                errorMessage.classList.remove('hidden'); 
                errorMessage.querySelector('p').textContent = 'Error loading video.';
                errorMessage.querySelector('p:last-child').textContent = 'Trying another video.';
                setTimeout(showNextVideo, 2000); 
            };

            mainPlayer.src = url;
            managePreloading(); 

            if (history.length <= 1) mainPlayer.muted = true;
            updateMuteIcon();
        }
        
        function showNextVideo() {
            const readyUrl = getReadyPreloadedVideo();
            if (readyUrl) {
                playTrailer(readyUrl);
            } else {
                const nextIndex = getNewRandomIndex(Array.from(preloadingUrls));
                playTrailer(nextIndex);
            }
        }

        function showPreviousVideo() {
            if (history.length > 1) { history.pop(); playTrailer(history[history.length - 1], true); }
        }

        function toggleUiVisibility() {
            isUiHidden = !isUiHidden;
            [loopBtn, muteBtn, bottomControls, qualityMenuBtn].forEach(el => el?.classList.toggle('hidden', isUiHidden));
            iconEyeVisible.classList.toggle('hidden', isUiHidden);
            iconEyeHidden.classList.toggle('hidden', !isUiHidden);
            if (!isUiHidden) qualityPopover.classList.add('hidden');
        }

        function showStats() {
            if (originalVideoList.length === 0) return;
            statsTotal.textContent = originalVideoList.length;
            statsPomf.textContent = originalVideoList.filter(url => url.includes('pomf2.lain.la/')).length;
            statsTwitter.textContent = originalVideoList.filter(url => url.includes('video.twimg.com/amplify_video')).length;
            statsTwitterFhd.textContent = originalVideoList.filter(url => url.includes('video.twimg.com/amplify_video') && url.includes('1080')).length;
            statsModal.classList.remove('hidden');
        }

        // --- EVENT LISTENERS ---
        playOverlay.addEventListener('click', () => mainPlayer.play().then(startTrailerPlayback));
        toggleViewBtn.addEventListener('click', () => setViewMode(!isFullScreen));
        [fsNextBtn, topNextBtn].forEach(btn => btn.addEventListener('click', showNextVideo));
        [fsPrevBtn, topPrevBtn].forEach(btn => btn.addEventListener('click', showPreviousVideo));
        muteBtn.addEventListener('click', () => { mainPlayer.muted = !mainPlayer.muted; updateMuteIcon(); });
        loopBtn.addEventListener('click', () => {
            isLooping = !isLooping;
            loopBtn.classList.toggle('text-blue-500', isLooping);
            loopBtn.classList.toggle('text-white/70', !isLooping);
        });
        hideUiBtn.addEventListener('click', toggleUiVisibility);
        playFullBtn.addEventListener('click', () => {
            mainPlayer.pause();
            clearTimers();
            modalPlayer.src = mainPlayer.src;
            modalPlayer.currentTime = 0;
            videoModal.classList.remove('hidden');
        });
        const closeModal = () => {
            videoModal.classList.add('hidden');
            modalPlayer.pause();
            modalPlayer.src = '';
            mainPlayer.play().then(startTrailerPlayback).catch(err => {
                playOverlay.classList.remove('hidden');
            });
        };
        closeModalBtn.addEventListener('click', closeModal);
        videoModal.addEventListener('click', (e) => { if (e.target === videoModal) closeModal(); });
        copyLinkBtn.addEventListener('click', () => {
            const textArea = document.createElement('textarea');
            textArea.value = modalPlayer.src;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand('copy');
            document.body.removeChild(textArea);
            const copyIcon = copyLinkBtn.querySelector('.copy-icon');
            const checkIcon = copyLinkBtn.querySelector('.check-icon');
            copyIcon.classList.add('hidden');
            checkIcon.classList.remove('hidden');
            setTimeout(() => {
                copyIcon.classList.remove('hidden');
                checkIcon.classList.add('hidden');
            }, 2000);
        });
        qualityMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            qualityPopover.classList.toggle('hidden');
        });
        qualityFilterBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                applyFilterAndPlay(e.currentTarget.dataset.filter);
            });
        });
        infoBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            qualityPopover.classList.add('hidden');
            showStats();
        });
        closeStatsModalBtn.addEventListener('click', () => statsModal.classList.add('hidden'));
        statsModal.addEventListener('click', (e) => { if (e.target === statsModal) statsModal.classList.add('hidden'); });
        document.addEventListener('click', () => qualityPopover.classList.add('hidden'));

        // --- PASSWORD & INITIALIZATION LOGIC ---
        function checkPassword() {
            if (passwordInput.value === CORRECT_PASSWORD) {
                // Save the successful login state to the session
                sessionStorage.setItem('passwordEntered', 'true');
                passwordOverlay.classList.add('hidden');
                initApp();
            } else {
                passwordError.classList.remove('hidden');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }

        submitPasswordBtn.addEventListener('click', checkPassword);
        passwordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        async function initApp() {
            await fetchVideoList();
            if (originalVideoList.length > 0) {
                setViewMode(true);
                applyFilterAndPlay('All');
            } else {
                playerWrapper.classList.add('hidden');
            }
        }
        
        // Check if the password was already entered in this session
        if (sessionStorage.getItem('passwordEntered') === 'true') {
            passwordOverlay.classList.add('hidden');
            initApp();
        } else {
            passwordOverlay.classList.remove('hidden');
            passwordInput.focus();
        }

    </script>
</body>
</html>
